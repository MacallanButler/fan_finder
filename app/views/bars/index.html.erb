<% if current_user.team %>
  <style>
    body {
      background-color: <%= current_user.team.secondary_color %> !important;
    }
  </style>
<% end %>

<div class="max-w-4xl mx-auto px-4 py-8">
  <h1 class="text-3xl font-bold text-white mb-8">Find Your Teams Bars</h1>

  <% if current_user.team %>
    <div class="border-2 rounded-lg p-4 mb-6" 
         style="background-color: <%= current_user.team.primary_color %>; border-color: <%= current_user.team.primary_color %>;">
      <p class="text-white">
        Your team: <span class="font-semibold"><%= current_user.team.name %></span>
      </p>
      <%= link_to "Change Team", teams_select_path, class: "text-white hover:underline text-sm opacity-90" %>
    </div>
  <% end %>

  <div class="bg-white shadow rounded-lg p-6 mb-6">
    <%= form_with url: bars_path, method: :get, id: "search-form", class: "space-y-3" do |f| %>
      <div class="flex gap-2">
        <%= f.text_field :city, placeholder: "Enter city (e.g. San Francisco)", 
            id: "city-input",
            class: "flex-1 px-4 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2", 
            style: "focus:ring-color: #{current_user.team&.primary_color || '#3B82F6'};" %>
        <%= f.submit "Find Bars", class: "text-white px-6 py-2 rounded hover:opacity-90 cursor-pointer font-semibold", 
            style: "background-color: #{current_user.team&.primary_color || '#3B82F6'};" %>
      </div>
      <button type="button" id="use-location" class="hover:underline text-sm" style="color: <%= current_user.team&.primary_color || '#3B82F6' %>;">
        ğŸ“ Use My Current Location
      </button>
    <% end %>
  </div>

  <div class="bg-green-50 border-2 border-green-200 rounded-lg p-6 mb-6 text-center">
    <p class="text-gray-700 mb-3">Know a bar that shows your teams games?</p>
    <%= link_to "Add a Bar to Our Database", new_bar_path, class: "inline-block bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 font-semibold" %>
  </div>

  <% if @bars %>
    <div class="bg-white shadow rounded-lg p-6">
      <h2 class="text-2xl font-semibold mb-4">Bars in <%= @city %></h2>
      
      <% if @bars.any? %>
        <div class="space-y-4">
          <% @bars.each do |bar| %>
            <div class="border-b pb-4 last:border-0" style="border-color: <%= current_user.team.primary_color %>30;">
              <h3 class="text-xl font-semibold text-gray-900"><%= bar.name %></h3>
              <p class="text-gray-600"><%= bar.address %></p>
              <p class="text-sm text-gray-500"><%= bar.city %></p>
            </div>
          <% end %>
        </div>
      <% else %>
        <p class="text-gray-500">No bars found for <%= current_user.team.name %> in <%= @city %></p>
      <% end %>
    </div>
  <% end %>
</div>

<script>
document.getElementById('use-location').addEventListener('click', function() {
  const btn = this;
  const cityInput = document.getElementById('city-input');
  
  btn.textContent = 'ğŸ”„ Getting location...';
  btn.disabled = true;
  
  if (!navigator.geolocation) {
    alert('Geolocation not supported by your browser');
    btn.textContent = 'ğŸ“ Use My Current Location';
    btn.disabled = false;
    return;
  }
  
  navigator.geolocation.getCurrentPosition(
    function(position) {
      const lat = position.coords.latitude;
      const lon = position.coords.longitude;
      
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`)
        .then(response => response.json())
        .then(data => {
          const city = data.address.city || data.address.town || data.address.village || data.address.county;
          cityInput.value = city;
          btn.textContent = 'ğŸ“ Use My Current Location';
          btn.disabled = false;
          document.getElementById('search-form').requestSubmit();
        })
        .catch(error => {
          alert('Could not get city name');
          btn.textContent = 'ğŸ“ Use My Current Location';
          btn.disabled = false;
        });
    },
    function(error) {
      alert('Unable to get your location. Please enter city manually.');
      btn.textContent = 'ğŸ“ Use My Current Location';
      btn.disabled = false;
    }
  );
});
</script>